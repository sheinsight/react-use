# ğŸ•¸ ä¾èµ–æ”¶é›†ï¼ˆDependencies Collectionï¼‰ {#dependencies-collection}

`@shined/react-use` ä½œä¸ºåŸºç¡€çš„åº•å±‚å·¥å…·åº“ï¼Œæ€§èƒ½æ˜¯é‡ä¸­ä¹‹é‡ï¼Œä¸ºäº†åœ¨ç¡®ä¿çµæ´»æ€§ã€åŠŸèƒ½ä¸°å¯Œçš„å‰æä¸‹å°½å¯èƒ½åœ°å‡å°‘æ€§èƒ½å¼€é”€ï¼Œæˆ‘ä»¬å¼•å…¥äº†ä¾èµ–æ”¶é›†ï¼ˆDependencies Collectionï¼‰çš„æ¦‚å¿µã€‚

> ä¾èµ–æ”¶é›†çš„æƒ³æ³•æœ€åˆæ¥æºäº [SWR](https://swr.vercel.app/docs/advanced/performance#dependency-collection)ï¼Œåœ¨æ­¤åŸºç¡€ä¸Šæˆ‘ä»¬è¿›è¡Œäº†ä¸€äº›æ”¹è¿›å’Œä¼˜åŒ–ã€‚

## ç®€è€Œè¨€ä¹‹ {#tl-dr}

- ä¸ºäº†æä¾›çµæ´»ã€ä¸°å¯Œçš„åŠŸèƒ½ï¼Œè®¸å¤š Hooks å†…éƒ¨éœ€è¦ç®¡ç†å’Œè¿”å›è®¸å¤šçŠ¶æ€ï¼ˆStateï¼‰
- ç”¨æˆ·å¯èƒ½å¹¶ä¸éœ€è¦æ¶ˆè´¹æ‰€æœ‰çš„çŠ¶æ€ï¼Œåªç”¨åˆ°äº†å…¶ä¸­çš„ä¸€éƒ¨åˆ†ï¼Œä½†æ˜¯ä»»æ„çŠ¶æ€å˜åŒ–éƒ½ä¼šå¯¼è‡´é‡æ¸²æŸ“
- ä¸ºäº†å‡å°‘ä¸å¿…è¦çš„æ¸²æŸ“å¼€é”€ï¼Œæˆ‘ä»¬å¼•å…¥äº†ã€Œä¾èµ–æ”¶é›†ï¼ˆDependencies Collectionï¼‰ã€çš„æ¦‚å¿µ
- åªæœ‰ç”¨åˆ°çš„çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶æ‰ä¼šè§¦å‘æ¸²æŸ“ï¼Œè¿™å¯¹ç”¨æˆ·æ¥è¯´æ˜¯æ— æ„Ÿçš„ï¼Œä½†æ˜¯å¯ä»¥æ˜¾è‘—æå‡æ€§èƒ½

## åŠ¨æœº

åœ¨ `@shined/react-use` å†…éƒ¨æœ‰ä¸€ä¸ª `useQuery`ï¼Œå®ƒä¸ºäº†å®ç°è¯¸å¤šåŠŸèƒ½ç‰¹æ€§ï¼Œè¿”å›äº†åŒ…æ‹¬ä½†ä¸é™äº `data`ã€`loading`ã€`error` ç­‰å¤šä¸ªçŠ¶æ€ã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼Œæ— è®ºæ˜¯å¦ä½¿ç”¨äº†è¿”å›çš„çŠ¶æ€ï¼Œåªè¦å¯¹åº”çŠ¶æ€å‘ç”Ÿäº†å˜æ›´ï¼Œå†…éƒ¨å°±ä¼šè°ƒç”¨ç±»ä¼¼ `setState(loading)` çš„æ“ä½œæ¥æ›´æ–°çŠ¶æ€ã€‚

è¿™ä¸ªæ“ä½œé€»è¾‘æœ¬èº«å¹¶æ²¡æœ‰é—®é¢˜ï¼Œé—®é¢˜åœ¨äºï¼Œå½“ç”¨æˆ·å®é™…ä¸Šå¹¶æœªä½¿ç”¨æŸäº›çŠ¶æ€æ—¶ä»ç„¶ä¼šè¿›è¡Œæ›´æ–°ï¼Œå¯¼è‡´äº†ä¸å¿…è¦çš„æ¸²æŸ“å¼€é”€ï¼Œæå¤§é™ä½äº†æ¸²æŸ“æ€§èƒ½ã€‚

```tsx
// ç”¨æˆ·å®é™…ä¸Šåªéœ€è¦ run æ“ä½œå’Œ loading è¿™ä¸€ä¸ªçŠ¶æ€ï¼Œå¯¹äº errorã€data å…¶å®å¹¶ä¸å…³å¿ƒ
const { run, data } = useQuery(requestSomething, options)

// ç”¨æˆ·æ‰§è¡Œ run æ“ä½œ
run()

// å½“ dataã€errorã€loading æ”¹å˜æ—¶ï¼Œå†…éƒ¨ä¼šè§¦å‘ `setState` æ“ä½œå¯¼è‡´ç»„ä»¶é‡æ–°æ¸²æŸ“
```

åœ¨æŸäº›åœºæ™¯ä¸‹ï¼ˆå¦‚ä¸Šï¼‰ï¼Œæˆ‘ä»¬å¯èƒ½åªéœ€è¦å…¶ä¸­çš„ä¸€ä¸ªçŠ¶æ€ï¼Œæ¯”å¦‚ `data`ï¼Œè€Œä¸éœ€è¦å…¶ä»–çŠ¶æ€ã€‚ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å¼•å…¥äº†ä¾èµ–æ”¶é›†çš„æ¦‚å¿µï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡ä¼ å…¥ä¾èµ–é¡¹çš„æ–¹å¼å‘Šè¯‰ `@shined/react-use` å“ªäº›çŠ¶æ€æ˜¯ä»–ä»¬å…³å¿ƒçš„ï¼Œå“ªäº›æ˜¯ä¸å…³å¿ƒçš„ã€‚

```tsx
// ç”¨æˆ·éœ€è¦ä»€ä¹ˆï¼Œå°±ä»è¿”å›å€¼é‡Œé¢å–ä»€ä¹ˆ
const { run, data } = useQuery(requestSomething, options)

// ç”¨æˆ·æ‰§è¡Œ run æ“ä½œ
run()

// å½“ data æ”¹å˜æ—¶ï¼Œå†…éƒ¨ä¼šè§¦å‘ `setState` æ“ä½œå¯¼è‡´ç»„ä»¶é‡æ–°æ¸²æŸ“

// è€Œå¯¹äº errorã€loadingï¼Œå³ä½¿æ”¹å˜äº†ä¹Ÿä¸ä¼šè§¦å‘é‡æ–°æ¸²æŸ“ï¼Œå› ä¸ºç”¨æˆ·å¹¶æ²¡æœ‰å®é™…ç”¨åˆ°
```

åŸæœ¬éœ€è¦æ¸²æŸ“ 4~5 æ¬¡çš„ç»„ä»¶ï¼Œç°åœ¨å¯èƒ½åªéœ€è¦æ¸²æŸ“ 1~2 æ¬¡ï¼Œè¿™å¯¹äºæ€§èƒ½æå‡æ¥è¯´ï¼Œæ— ç–‘æ˜¯ç›¸å½“å·¨å¤§çš„ã€‚

## å®ç°äº†ä¾èµ–æ”¶é›†çš„ Hooks {#hooks-that-implemented-dependencies-collection}

- [useAsyncFn](/reference/use-async-fn)
- [useClipboard](/reference/use-clipboard)
- [useClipboardItems](/reference/use-clipboard-items)
- [useLoadingSlowFn](/reference/use-loading-slow-fn)
- [useQuery](/reference/use-query)
- [~~useRequestï¼ˆå·²å¼ƒç”¨ï¼Œè¯·ä½¿ç”¨ useQuestï¼‰~~](/reference/use-request)

ç”±äºå·¥ä½œé‡å·¨å¤§ï¼Œæˆ‘ä»¬ç›®å‰åªå¯¹éƒ¨åˆ† Hooks è¿›è¡Œäº†ä¾èµ–æ”¶é›†çš„ä¼˜åŒ–ï¼Œæœªæ¥ä¼šé€æ­¥å¯¹å…¶ä»– Hooks è¿›è¡Œä¼˜åŒ–ã€‚

## å®ç°åŸç† {#implementation}

å®ç°åŸç†å…¶å®å¾ˆç®€å•ï¼Œåªéœ€è¦åœ¨å†…éƒ¨ç»´æŠ¤ä¸€ä¸ª `ref`ï¼ŒåŒæ—¶åœ¨æš´éœ²è¿”å›å€¼æ—¶ï¼Œé€šè¿‡ `getter` å‡½æ•°è¿›è¡Œæ ‡è®°ï¼Œå½“ç”¨æˆ·ä½¿ç”¨åˆ°æŸä¸ªçŠ¶æ€æ—¶ï¼Œå°†è¿™ä¸ªçŠ¶æ€æ ‡è®°ä¸ºã€Œå·²ä½¿ç”¨ã€ï¼Œåœ¨å˜æ›´æ—¶åˆ¤æ–­æ˜¯å¦éœ€è¦è§¦å‘é‡æ–°æ¸²æŸ“ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ä¼ªä»£ç æ¥æ¼”ç¤ºä¾èµ–æ”¶é›†çš„åº•å±‚åŸç†ï¼š

```tsx
// ä½¿ç”¨ useRef è€Œä¸æ˜¯ useState æ¥å®šä¹‰çŠ¶æ€ï¼Œå› ä¸ºæˆ‘ä»¬å¸Œæœ›æ‰‹åŠ¨æ§åˆ¶çŠ¶æ€çš„æ›´æ–°
const stateRef = useRef({
  name: { used: false, value: 'react-use' },
  age: { used: false, value: 18 },
})

// é€šè¿‡ setState å‡½æ•°æ¥æ‰‹åŠ¨æ›´æ–°çŠ¶æ€ï¼ŒåŒæ—¶åˆ¤æ–­æ˜¯å¦éœ€è¦è§¦å‘é‡æ–°æ¸²æŸ“
function setState(key: string, value: any) {
  if(stateRef.current[key].value === value) return
  stateRef.current[key].value = value
  if (stateRef.current[key].used) render()
}

// è¿”å›å€¼é€šè¿‡ getter å‡½æ•°æš´éœ²ï¼ŒåŒæ—¶åœ¨ getter å‡½æ•°ä¸­æ ‡è®°çŠ¶æ€æ˜¯å¦è¢«ä½¿ç”¨
const returnedState = {
  get name() {
    stateRef.current.name.used = true
    return stateRef.current.name.value
  },
  get age() {
    stateRef.current.age.used = true
    return stateRef.current.age.value
  },
}
```

é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°ä¸€ä¸ªç®€å•çš„ä¾èµ–æ”¶é›†ç³»ç»Ÿï¼Œåªæœ‰å½“ç”¨æˆ·ä½¿ç”¨åˆ°äº†æŸä¸ªçŠ¶æ€æ—¶æ‰ä¼šè§¦å‘é‡æ–°æ¸²æŸ“ã€‚åœ¨ `@shine/react-use` å†…éƒ¨ï¼Œè¿™ä¸€æ•´å¥—é€»è¾‘è¢«æ•´åˆåˆ° `useTrackedRefState()` Hook ï¼ˆç›®å‰å°šæœªå¯¹å¤–æš´éœ²ï¼‰å½“ä¸­ï¼Œç”¨äºå®ç°ä¾èµ–æ”¶é›†çš„åŠŸèƒ½ã€‚
